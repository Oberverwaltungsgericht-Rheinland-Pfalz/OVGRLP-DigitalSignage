(function () {
    var app = angular.module('app.displays');

    app.controller('DisplaysController', function ($scope, Restangular) {
        var columnDefs = [
            { headerName: 'Gruppe', field: 'group'},
            { headerName: 'Name', field: 'name'},
            { headerName: 'Titel', field: 'title'},
            { headerName: 'Status', field: 'status' },
            { headerName: '', template: '<a ui-sref="displays.details({id:data.id})">Details</a>' }
        ];

        var baseDisplays = Restangular.all('settings/displays');

        $scope.gridOptions = {
            angularCompileRows: true,            columnDefs: columnDefs,
            rowData: null
        };

        baseDisplays.getList().then(function (data) {
            $scope.gridOptions.rowData = data;
            $scope.gridOptions.rowData.forEach(function (display) {
                display.status = -1;
                display.customGET('status').then(function (data) {
                    display.status = data.result;
                    display.volatile = true;
                    $scope.gridOptions.api.softRefreshView();
                    console.log('soft refresh: ' + display.status)
                });
            });
            $scope.gridOptions.api.onNewRows();
        });


    });

    app.controller('DisplayController', function ($scope, $stateParams, Restangular) {
        var baseDisplay = Restangular.one('settings/displays', $stateParams.id);

        baseDisplay.get(function (display) {
            display.status = -1;
            display.customGET('status').then(function (data) {
                display.status = data.result;
            });
            $scope.display = display;
        });

        $scope.poweron = function () {
            if ($scope.display && $scope.display.controlUrl) {
                $scope.display.customGET('start').then(function (data) {
                });
            };
        };

        $scope.restart = function () {
            if ($scope.display && $scope.display.controlUrl) {
                $http.get($scope.display.controlUrl + '/api/restart');
            };
        };

        $scope.shutdown = function () {
            if ($scope.display && $scope.display.controlUrl) {
                $http.get($scope.display.controlUrl + '/api/shutdown');
            };
        };

        $scope.refresh = function () {
            if ($scope.display && $scope.display.controlUrl) {
                update();
            };
        };

        update = function () {
            if ($scope.display && $scope.display.controlUrl) {
                $scope.loading = true;

                $scope.display.status = -1;
                $scope.display.customGET('status').then(function (data) {
                    $scope.display.status = data.result;

                    if ($scope.display.status < 1) {
                        $scope.screenshot = '../assets/img/offline-display.png';
                    } else {
                        $scope.screenshot = $scope.display.controlUrl + '/api/screenshot?dt=' + new Date().getTime();
                    };

                    $scope.loading = false;
                }, function (error) {
                    $scope.loading = false;
                });
            };
        };
    });

    app.factory('Displays', function (Restangular) {
        Restangular.extendModel('settings/displays', function (model) {
            model.status = 0;

            model.updateStatus = function () {
                model.status = -1;
                model.customGET('status').then(function (data) {
                    model.status = data.result;
                });
            };

            return model;
        });

        return Restangular.service('settings/displays');
    });
})();